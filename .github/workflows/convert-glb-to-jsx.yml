name: Convert GLB to JSX (All Missing)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  convert-glb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ensures we can check previous commits

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install gltfjsx
        run: npm install -g gltfjsx

      - name: Find All GLB Files Without JSX
        id: find-missing-jsx
        run: |
          mkdir -p models/gltfjsx
          MISSING_JSX_FILES=""

          # Find all .glb files in models/glb/
          for glb_file in $(find models/glb -name "*.glb"); do
            category=$(basename "$(dirname "$glb_file")")
            output_dir="models/gltfjsx/$category"
            model_name=$(basename "$glb_file" .glb)
            output_file="$output_dir/$model_name.jsx"

            # Check if JSX already exists
            if [ ! -f "$output_file" ]; then
              echo "‚è≥ Missing JSX for: $glb_file"
              mkdir -p "$output_dir"
              MISSING_JSX_FILES+="$glb_file\n"
            else
              echo "‚úÖ JSX already exists for: $glb_file"
            fi
          done

          # Save the missing files to an env variable
          echo -e "FILES_TO_CONVERT<<EOF\n$MISSING_JSX_FILES\nEOF" >> $GITHUB_ENV

      - name: Convert Missing GLB Files to JSX
        if: env.FILES_TO_CONVERT != ''
        run: |
          echo "Converting missing files..."
          while IFS= read -r glb_file; do
            [ -z "$glb_file" ] && continue

            category=$(basename "$(dirname "$glb_file")")
            output_dir="models/gltfjsx/$category"
            model_name=$(basename "$glb_file" .glb)
            output_file="$output_dir/$model_name.jsx"

            echo "üöÄ Converting $glb_file -> $output_file"
            if gltfjsx "$glb_file" -o "$output_file"; then
              echo "‚úÖ Successfully converted: $output_file"
            else
              echo "‚ùå Failed to convert: $glb_file"
            fi
          done <<< "$(echo -e "$FILES_TO_CONVERT")"

      - name: Commit and Push New JSX Files
        if: env.FILES_TO_CONVERT != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add models/gltfjsx/
          git commit -m "Added missing JSX files from GLB models" || echo "‚ö†Ô∏è No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git main
