name: Convert Updated GLB to JSX

on:
  push:
    branches: ["main"]
    paths:
      - "models/glb/**/*.glb"
  workflow_dispatch:

jobs:
  convert-glb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install gltfjsx
        run: npm install -g gltfjsx

      - name: Check gltfjsx version
        run: gltfjsx --version

      - name: Find Modified GLB Files
        id: changed-files
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            FILES=$(git diff --name-only HEAD^ HEAD -- 'models/glb/**/*.glb')
          else
            FILES=$(git ls-files -- 'models/glb/**/*.glb')
          fi
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "Modified GLB files: $FILES" # Debugging output
          git diff --name-only HEAD^ HEAD -- 'models/glb/**/*.glb' #added for debugging
        shell: bash

      - name: Convert or Update JSX Files
        if: env.FILES != ''
        run: |
          GITHUB_BASE_URL="https://raw.githubusercontent.com/Sudhanshu-Ambastha/Pokemon-3D/main"
          while IFS= read -r glb_file; do
            [ -z "$glb_file" ] && continue
            category=$(basename "$(dirname "$glb_file")")
            output_dir="models/gltfjsx/$category"
            mkdir -p "$output_dir"
            model_name=$(basename "$glb_file" .glb)
            output_file="$output_dir/$model_name.jsx"
            github_url="$GITHUB_BASE_URL/$glb_file"

            if [ -f "$output_file" ]; then
              if grep -q "useGLTF(\"$github_url\")" "$output_file"; then
                echo "âœ… $output_file is already up to date."
                continue
              else
                echo "âš ï¸ Fixing path in: $output_file"
              fi
            else
              echo "ðŸš€ Converting new model: $glb_file -> $output_file"
              npx gltfjsx "$glb_file" -o "$output_file"
            fi

            sed -i 's/export function Model/export default function Model/' "$output_file"
            sed -i "s|useGLTF(\".*.glb\")|useGLTF(\"$github_url\")|" "$output_file"
            sed -i "s|useGLTF.preload(\".*.glb\")|useGLTF.preload(\"$github_url\")|" "$output_file"
            echo "âœ… Updated JSX: $output_file"
          done < <(echo "$FILES")
        shell: bash

      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B update-jsx-files
          git add models/gltfjsx/
          git status #debugging output
          git commit -m "Updated JSX files for modified GLB models" || echo "No changes to commit"
          git push -f https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git update-jsx-files
        shell: bash
