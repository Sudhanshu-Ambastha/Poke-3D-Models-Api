name: Update JSX File Paths

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  update-jsx-paths:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure full history is available

      - name: Find Uncommitted JSX Files
        id: uncommitted-jsx
        run: |
          UNCOMMITTED_FILES=$(git ls-files --others --exclude-standard -- models/gltfjsx/*.jsx)
          echo "Uncommitted JSX files: $UNCOMMITTED_FILES"
          echo "UNCOMMITTED_FILES=$UNCOMMITTED_FILES" >> $GITHUB_ENV

      - name: Find and Update JSX Files
        id: update-jsx
        run: |
          GITHUB_BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          UPDATED_FILES=""

          # Find all JSX files inside models/gltfjsx/ (including uncommitted ones)
          for jsx_file in $(find models/gltfjsx -name "*.jsx"); do
            model_name=$(basename "$jsx_file" .jsx)
            glb_file=$(find models/glb -name "$model_name.glb" | head -n 1)  # Find corresponding GLB file
            
            if [ -z "$glb_file" ]; then
              echo "‚ùå No matching GLB found for $jsx_file, skipping..."
              continue
            fi

            github_glb_url="$GITHUB_BASE_URL/$glb_file"

            # Update useGLTF paths
            if grep -q 'useGLTF("' "$jsx_file"; then
              if ! grep -q "useGLTF(\"$github_glb_url\")" "$jsx_file"; then
                echo "üîÑ Updating path in: $jsx_file"
                sed -i "s|useGLTF(\".*.glb\")|useGLTF(\"$github_glb_url\")|" "$jsx_file"
                sed -i "s|useGLTF.preload(\".*.glb\")|useGLTF.preload(\"$github_glb_url\")|" "$jsx_file"
                UPDATED_FILES+="$jsx_file\n"
              fi
            fi

            # Ensure default export
            if grep -q "export function Model" "$jsx_file"; then
              echo "üîÑ Converting to default export: $jsx_file"
              sed -i 's/export function Model/export default function Model/' "$jsx_file"
              UPDATED_FILES+="$jsx_file\n"
            fi
          done

          # Save the updated files to an env variable
          echo -e "UPDATED_FILES<<EOF\n$UPDATED_FILES\nEOF" >> $GITHUB_ENV

      - name: Commit and Push Changes
        if: env.UPDATED_FILES != '' || env.UNCOMMITTED_FILES != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B update-jsx-paths
          
          # Stage changes, including uncommitted JSX files
          git add models/gltfjsx/
          git status  # Debugging output
          
          git commit -m "Updated JSX file paths and exports" || echo "No changes to commit"
          git push -f https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git update-jsx-paths
